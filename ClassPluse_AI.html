<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Companion</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        
        /* Custom Scrollbar (Dark Mode) */
        .custom-scrollbar-dark::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar-dark::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar-dark::-webkit-scrollbar-thumb { background-color: rgba(255, 255, 255, 0.1); border-radius: 20px; }

        /* Custom Scrollbar (Light Mode) */
        .custom-scrollbar-light::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar-light::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar-light::-webkit-scrollbar-thumb { background-color: rgba(0, 0, 0, 0.1); border-radius: 20px; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        .animate-slide-up { animation: slideUp 0.5s ease-out; }

        .paper-doc {
            font-family: 'Merriweather', serif;
            line-height: 1.8;
            color: #1a1a1a;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen overflow-hidden">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const Icons = {
            Mic: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" x2="12" y1="19" y2="22"/></svg>,
            Square: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="3" rx="2" /></svg>,
            Settings: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Folder: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/></svg>,
            FileText: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>,
            BookOpen: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>,
            Loader2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            Send: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>,
            Volume2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>,
            Clock: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Plus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" x2="12" y1="5" y2="19"/><line x1="5" x2="19" y1="12" y2="12"/></svg>,
            Download: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>,
            Globe: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><line x1="2" x2="22" y1="12" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>
        };

        // --- APP COMPONENT ---
        const App = () => {
            const [activeTab, setActiveTab] = useState('record'); 
            const [resultTab, setResultTab] = useState('notes'); 
            const [inputText, setInputText] = useState('');
            const [interimText, setInterimText] = useState('');
            const [isRecording, setIsRecording] = useState(false);
            const [greeting, setGreeting] = useState('Good Morning');
            const [showGreeting, setShowGreeting] = useState(true);
            const [isProcessing, setIsProcessing] = useState(false);
            const [language, setLanguage] = useState('en-US');
            const [micError, setMicError] = useState(null);
            
            // Data
            const [generatedNotes, setGeneratedNotes] = useState('');
            const [generatedQuiz, setGeneratedQuiz] = useState([]);
            const [history, setHistory] = useState([]);

            const textareaRef = useRef(null);
            const recognitionRef = useRef(null);

            useEffect(() => {
                const hours = new Date().getHours();
                let timeGreeting = 'Hello';
                if (hours < 12) timeGreeting = 'Good Morning';
                else if (hours < 18) timeGreeting = 'Good Afternoon';
                else timeGreeting = 'Good Evening';
                // FIXED: Added backticks for template literal
                setGreeting(`${timeGreeting}, User`);

                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    recognitionRef.current = new SpeechRecognition();
                    recognitionRef.current.continuous = true;
                    recognitionRef.current.interimResults = true;
                    recognitionRef.current.lang = language;

                    recognitionRef.current.onstart = () => {
                        setIsRecording(true);
                        setMicError(null);
                    };

                    recognitionRef.current.onend = () => {
                        // FIXED: Added check for clean stop vs error to prevent loop
                        if (isRecording) {
                             try {
                                recognitionRef.current.start();
                             } catch(e) {
                                 console.warn("Could not restart mic", e);
                                 setIsRecording(false);
                             }
                        } else {
                            setIsRecording(false);
                            setInterimText('');
                        }
                    };

                    recognitionRef.current.onresult = (event) => {
                        let finalTranscript = '';
                        let interimTranscript = '';

                        for (let i = event.resultIndex; i < event.results.length; ++i) {
                            if (event.results[i].isFinal) {
                                finalTranscript += event.results[i][0].transcript;
                            } else {
                                interimTranscript += event.results[i][0].transcript;
                            }
                        }
                        
                        if (finalTranscript) {
                            setInputText(prev => prev + (prev ? ' ' : '') + finalTranscript);
                            setShowGreeting(false);
                        }
                        
                        setInterimText(interimTranscript);
                        if (interimTranscript) setShowGreeting(false);
                    };

                    recognitionRef.current.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        if (event.error === 'not-allowed') {
                            setMicError("Microphone access denied.");
                            setIsRecording(false); // Stop trying to record
                        } else if (event.error === 'no-speech') {
                            // ignore
                        } else {
                            setMicError("Error recording: " + event.error);
                            setIsRecording(false);
                        }
                    };
                } else {
                    setMicError("Speech recognition not supported in this browser.");
                }
            }, [language]); 

            useEffect(() => {
                if (recognitionRef.current) {
                    recognitionRef.current.lang = language;
                }
            }, [language]);

            const handleInputChange = (e) => {
                const text = e.target.value;
                setInputText(text);
                
                if (textareaRef.current) {
                    textareaRef.current.style.height = 'auto';
                    textareaRef.current.style.height = textareaRef.current.scrollHeight + 'px';
                }

                if (text.length > 0 && showGreeting) {
                    setShowGreeting(false);
                } else if (text.length === 0 && !isRecording) {
                    setShowGreeting(true);
                }
            };

            const toggleRecording = () => {
                if (!recognitionRef.current) {
                    alert("Speech Recognition not supported.");
                    return;
                }

                if (isRecording) {
                    // Explicitly stop
                    setIsRecording(false); 
                    recognitionRef.current.stop();
                    setInterimText('');
                } else {
                    try {
                        setIsRecording(true); // Set state first
                        recognitionRef.current.start();
                        setShowGreeting(false);
                    } catch (e) {
                        console.error("Mic error", e);
                        setIsRecording(false);
                    }
                }
            };

            const downloadNotes = () => {
                const element = document.createElement("a");
                const file = new Blob([generatedNotes], {type: 'text/plain'});
                element.href = URL.createObjectURL(file);
                element.download = "study_notes.txt";
                document.body.appendChild(element);
                element.click();
                document.body.removeChild(element);
            };

            const generateLongNotes = (text) => {
                // Break text into sentences to actually use the input data
                const sentences = text.match(/[^\.!\?]+[\.!\?]+/g) || [text];
                
                // Extract words for topic identification
                const words = text.split(/\s+/).map(w => w.replace(/[^a-zA-Z]/g, '')).filter(w => w.length > 4);
                const uniqueWords = [...new Set(words)];
                
                // Identify topic and keywords from input
                const topic = uniqueWords[0] ? uniqueWords[0].charAt(0).toUpperCase() + uniqueWords[0].slice(1) : "General Topic";
                const keyTerms = uniqueWords.slice(1, 6).map(w => w.charAt(0).toUpperCase() + w.slice(1));
                
                // Helper to find definition/context in text
                const findContext = (term) => {
                    const sentence = sentences.find(s => s.toLowerCase().includes(term.toLowerCase()));
                    return sentence ? sentence.trim() : `Usage of ${term} was noted in the discussion.`;
                };

                // Split sentences for sections
                const introSentences = sentences.slice(0, Math.min(3, sentences.length)).join(' ');
                const bodySentences = sentences.slice(Math.min(3, sentences.length)).join('\n   ');

                return `STUDY GUIDE: ${topic.toUpperCase()}
Date: ${new Date().toLocaleDateString()}
Language: ${language}

1. OVERVIEW & OBJECTIVES
${introSentences || "No detailed overview available from input."}

2. KEY TERMINOLOGY FROM SESSION
${keyTerms.length > 0 ? keyTerms.map(term => `   - ${term}: ${findContext(term)}`).join('\n') : '   - No specific terms identified; review the transcript for details.'}

3. DETAILED TRANSCRIPT ANALYSIS
   ${bodySentences || "Content analysis included in overview."}

4. STUDY RECOMMENDATIONS
   To retain this information, focus on active recall.
   - Review the definition of ${topic} tomorrow morning.
   - Create flashcards for: ${keyTerms.slice(0, 3).join(', ') || 'key concepts'}.

5. RAW SUMMARY
The session covered approximately ${words.length} key substantial words. The primary focus remained on ${topic} and associated concepts like ${keyTerms[0] || 'various elements'}.`;
            };

            const generateDynamicQuiz = (text) => {
                // Split text into sentences for context-based questions
                const sentences = text.match(/[^\.!\?]+[\.!\?]+/g) || [];
                const words = text.split(/\s+/).map(w => w.replace(/[^a-zA-Z]/g, '')).filter(w => w.length > 4);
                const uniqueWords = [...new Set(words)];
                
                const quizQuestions = [];
                const terms = uniqueWords.slice(0, 15); // Candidates for answers

                // 1. Try to generate "Fill in the blank" questions from actual sentences
                sentences.forEach((sentence, idx) => {
                    if (quizQuestions.length >= 7) return; // Limit generated questions

                    // Find a significant word in this sentence
                    const significantWord = terms.find(t => sentence.toLowerCase().includes(t.toLowerCase()));
                    
                    if (significantWord) {
                        // Create the question by masking the word
                        const questionText = sentence.replace(new RegExp(significantWord, 'i'), "______");
                        
                        // Create distractors from other terms or generic fallbacks
                        const otherTerms = terms.filter(t => t !== significantWord);
                        const distractors = otherTerms.sort(() => 0.5 - Math.random()).slice(0, 2);
                        
                        // If not enough distractors from text, add generic ones
                        while (distractors.length < 2) {
                            distractors.push(["Logic", "Data", "System", "Theory"][Math.floor(Math.random() * 4)]);
                        }

                        quizQuestions.push({
                            id: quizQuestions.length + 1,
                            question: `Complete the sentence: "${questionText.trim()}"`,
                            options: [significantWord, ...distractors].sort(() => Math.random() - 0.5),
                            correct: -1 // Will calculate after sorting
                        });
                    }
                });

                // 2. Fallback if not enough sentences were parsed
                if (quizQuestions.length < 5) {
                     const topic = uniqueWords[0] || "Topic";
                     quizQuestions.push({
                        id: quizQuestions.length + 1,
                        question: `What appears to be the main topic of the text?`,
                        options: [topic, "Ancient History", "Cooking Recipes"].sort(() => Math.random() - 0.5),
                        correct: -1
                     });
                }

                // Recalculate correct indices
                return quizQuestions.map(q => {
                    const answer = q.question.includes("main topic") ? (uniqueWords[0] || "Topic") : terms.find(t => q.options.includes(t));
                    // For fill-in-blank, the answer is the term that was masked. We need to store the answer explicitly or find it.
                    // Simplified approach: Finds the option that fits the blank context (heuristically) or just use the one we pushed first in logic.
                    // Better approach: passing the answer through the object construction.
                    
                    // Re-generating strictly to ensure correctness:
                    return {
                        ...q,
                        correct: q.options.indexOf(answer) !== -1 ? q.options.indexOf(answer) : 0 // Fallback to first if matching fails logic
                    };
                }).map(q => {
                    // Final fix for the answer mapping issue above
                    // Since I sorted options before finding index, I need to know strictly which one was correct.
                    // Let's rewrite the loop slightly in generation to be safer.
                    return q; 
                });
            };
            
            // REDEFINED FOR SAFETY
            const generateSafeQuiz = (text) => {
                const sentences = text.match(/[^\.!\?]+[\.!\?]+/g) || [text];
                const words = text.split(/\s+/).map(w => w.replace(/[^a-zA-Z]/g, '')).filter(w => w.length > 4);
                const uniqueWords = [...new Set(words)];
                const terms = uniqueWords.map(w => w.charAt(0).toUpperCase() + w.slice(1));
                
                const questions = [];

                // Strategy: Find a word in a sentence, mask it, make it the answer
                let count = 0;
                for (let s of sentences) {
                    if (count >= 10) break;
                    
                    // Find a term present in this sentence
                    const answer = terms.find(t => s.toLowerCase().includes(t.toLowerCase()));
                    if (answer) {
                        const questionStr = s.replace(new RegExp(answer, 'i'), "_______");
                        
                        // Distractors
                        const distractors = terms.filter(t => t !== answer).sort(() => 0.5 - Math.random()).slice(0, 2);
                        if (distractors.length < 2) distractors.push("None");
                        if (distractors.length < 2) distractors.push("Other");

                        const options = [answer, ...distractors].sort(() => 0.5 - Math.random());

                        questions.push({
                            id: count + 1,
                            question: `Complete: "${questionStr.trim()}"`,
                            options: options,
                            correct: options.indexOf(answer)
                        });
                        count++;
                    }
                }
                
                if (questions.length === 0) {
                     return [{
                        id: 1,
                        question: "No sufficient text provided to generate a quiz. Try entering longer sentences.",
                        options: ["Okay"],
                        correct: 0
                     }];
                }

                return questions;
            };


            const generateContent = () => {
                if (!inputText.trim()) return;
                setIsProcessing(true);
                
                setTimeout(() => {
                    const notes = generateLongNotes(inputText);
                    // Use the safe version
                    const quiz = generateSafeQuiz(inputText);

                    const newSession = {
                        id: Date.now(),
                        date: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                        fullDate: new Date().toLocaleDateString(),
                        text: inputText,
                        preview: inputText.slice(0, 40) + "...",
                        notes: notes,
                        quiz: quiz
                    };

                    setHistory(prev => [newSession, ...prev]);
                    setGeneratedNotes(notes);
                    setGeneratedQuiz(quiz);
                    setActiveTab('results');
                    setIsProcessing(false);
                    setResultTab('notes');
                }, 2000);
            };

            const resetSession = () => {
                setActiveTab('record');
                setInputText('');
                setInterimText('');
                setShowGreeting(true);
                setGeneratedNotes('');
                setGeneratedQuiz([]);
                if (textareaRef.current) textareaRef.current.style.height = 'auto';
            };

            const loadHistoryItem = (item) => {
                setInputText(item.text);
                setGeneratedNotes(item.notes);
                setGeneratedQuiz(item.quiz);
                setActiveTab('results');
                setResultTab('notes');
                setShowGreeting(false);
            };

            return (
                <div className="flex h-screen bg-slate-50 text-slate-800 font-sans overflow-hidden">
                    
                    {/* Sidebar */}
                    <aside className="w-16 flex flex-col items-center py-6 border-r border-gray-200 bg-white shadow-sm z-20">
                        <div className="mb-8 p-2 bg-violet-600 rounded-xl shadow-lg shadow-violet-200">
                            <Icons.Volume2 className="w-6 h-6 text-white" />
                        </div>
                        
                        <nav className="flex-1 flex flex-col gap-6 w-full items-center">
                            <SidebarIcon icon={<Icons.Mic />} active={activeTab === 'record'} onClick={resetSession} />
                            <SidebarIcon icon={<Icons.Clock />} active={activeTab === 'history'} onClick={() => setActiveTab('history')} />
                        </nav>

                        <div className="mt-auto">
                            <SidebarIcon icon={<Icons.Settings />} />
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 flex flex-col relative bg-slate-50">
                        
                        {/* Header */}
                        <header className="h-16 border-b border-gray-200 flex items-center justify-between px-8 bg-white/80 backdrop-blur z-10">
                            <div className="flex items-center gap-3">
                                <h1 className="text-lg font-medium text-slate-800">
                                    {activeTab === 'record' ? 'New Session' : activeTab === 'history' ? 'History' : 'Session Results'}
                                </h1>
                                {activeTab !== 'history' && (
                                    <>
                                        <span className="text-gray-400 text-sm">•</span>
                                        <span className="text-gray-500 text-sm">
                                            {inputText.split(' ').filter(w => w).length} words
                                        </span>
                                    </>
                                )}
                            </div>
                            <div className="flex items-center gap-4">
                                <div className="relative group">
                                    <button className="flex items-center gap-2 text-gray-500 hover:text-violet-600 transition-colors text-sm font-medium px-3 py-1.5 rounded-full hover:bg-slate-100">
                                        <Icons.Globe className="w-4 h-4" />
                                        {language === 'en-US' ? 'English (US)' : 
                                         language === 'hi-IN' ? 'Hindi' : 
                                         language === 'te-IN' ? 'Telugu' : 
                                         language === 'ta-IN' ? 'Tamil' :
                                         language === 'kn-IN' ? 'Kannada' :
                                         language === 'es-ES' ? 'Español' : 
                                         language === 'fr-FR' ? 'Français' : 'Deutsch'}
                                    </button>
                                    <div className="absolute right-0 top-full mt-2 w-48 bg-white border border-gray-100 rounded-lg shadow-xl overflow-hidden hidden group-hover:block z-50">
                                        <div className="p-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Local</div>
                                        <button onClick={() => setLanguage('en-US')} className="w-full text-left px-4 py-2 text-sm text-gray-600 hover:bg-violet-50 hover:text-violet-700">English (India/US)</button>
                                        <button onClick={() => setLanguage('hi-IN')} className="w-full text-left px-4 py-2 text-sm text-gray-600 hover:bg-violet-50 hover:text-violet-700">Hindi (हिन्दी)</button>
                                        <button onClick={() => setLanguage('te-IN')} className="w-full text-left px-4 py-2 text-sm text-gray-600 hover:bg-violet-50 hover:text-violet-700">Telugu (తెలుగు)</button>
                                        <button onClick={() => setLanguage('ta-IN')} className="w-full text-left px-4 py-2 text-sm text-gray-600 hover:bg-violet-50 hover:text-violet-700">Tamil (தமிழ்)</button>
                                        <button onClick={() => setLanguage('kn-IN')} className="w-full text-left px-4 py-2 text-sm text-gray-600 hover:bg-violet-50 hover:text-violet-700">Kannada (ಕನ್ನಡ)</button>
                                        <div className="border-t border-gray-100 my-1"></div>
                                        <div className="p-2 text-xs font-bold text-gray-400 uppercase tracking-wider">Global</div>
                                        <button onClick={() => setLanguage('es-ES')} className="w-full text-left px-4 py-2 text-sm text-gray-600 hover:bg-violet-50 hover:text-violet-700">Español</button>
                                        <button onClick={() => setLanguage('fr-FR')} className="w-full text-left px-4 py-2 text-sm text-gray-600 hover:bg-violet-50 hover:text-violet-700">Français</button>
                                        <button onClick={() => setLanguage('de-DE')} className="w-full text-left px-4 py-2 text-sm text-gray-600 hover:bg-violet-50 hover:text-violet-700">Deutsch</button>
                                    </div>
                                </div>
                                <div className="h-8 w-8 rounded-full bg-gradient-to-br from-violet-500 to-fuchsia-500 flex items-center justify-center text-xs font-bold shadow-inner text-white ring-2 ring-white">
                                    JD
                                </div>
                            </div>
                        </header>

                        {/* Content Area */}
                        <div className="flex-1 overflow-hidden relative flex flex-col items-center justify-center p-6">
                            
                            {/* RECORD / INPUT TAB */}
                            {activeTab === 'record' && (
                                <div className="w-full max-w-4xl h-full flex flex-col gap-6 relative animate-fade-in">
                                    {/* --- DARK THEME BOX START --- */}
                                    <div className="flex-1 bg-[#1A1B26] rounded-3xl border border-gray-800 shadow-2xl shadow-slate-900/20 relative overflow-hidden flex flex-col transition-all duration-300">
                                        {showGreeting && (
                                            <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none z-10 transition-opacity duration-500">
                                                <h2 className="text-4xl md:text-5xl font-light text-transparent bg-clip-text bg-gradient-to-r from-violet-200 to-fuchsia-200 tracking-tight">
                                                    {greeting}
                                                </h2>
                                                <p className="mt-4 text-gray-500 font-light">
                                                    Start recording or typing to create a quiz...
                                                </p>
                                            </div>
                                        )}
                                        <div className="flex-1 p-8 overflow-y-auto custom-scrollbar-dark relative z-0">
                                            <textarea
                                                ref={textareaRef}
                                                value={inputText + (interimText ? (inputText ? ' ' : '') + interimText : '')}
                                                onChange={handleInputChange}
                                                className="w-full h-full bg-transparent border-none outline-none resize-none text-xl md:text-2xl leading-relaxed text-gray-300 placeholder-gray-700 font-light"
                                                spellCheck="false"
                                            ></textarea>
                                        </div>
                                        <div className="p-6 bg-gradient-to-t from-[#1A1B26] via-[#1A1B26] to-transparent flex items-center justify-between border-t border-gray-800/30">
                                            <div className="flex flex-col gap-2">
                                                <div className="flex items-center gap-4">
                                                    <button 
                                                        onClick={toggleRecording}
                                                        /* FIXED: Added backticks */
                                                        className={`h-16 w-16 rounded-full flex items-center justify-center transition-all duration-300 ${isRecording ? 'bg-red-500 shadow-xl shadow-red-900/50 scale-110 ring-4 ring-red-500/30' : 'bg-violet-600 hover:bg-violet-500 shadow-xl shadow-violet-900/50 ring-4 ring-violet-500/20'}`}
                                                    >
                                                        {isRecording ? <Icons.Square className="w-6 h-6 text-white fill-current" /> : <Icons.Mic className="w-8 h-8 text-white" />}
                                                    </button>
                                                    {isRecording && (
                                                        <div className="flex items-center gap-2 px-4 py-2 bg-gray-900/50 rounded-full border border-gray-800 text-gray-300">
                                                            <div className="w-2 h-2 rounded-full bg-red-500 animate-pulse" />
                                                            <span className="text-xs font-mono font-medium">Listening ({language})...</span>
                                                        </div>
                                                    )}
                                                </div>
                                                {micError && <p className="text-xs text-red-400 mt-2 font-medium bg-red-900/20 px-2 py-1 rounded">{micError}</p>}
                                            </div>

                                            <button 
                                                onClick={generateContent}
                                                disabled={!inputText.trim() || isProcessing}
                                                /* FIXED: Added backticks */
                                                className={`flex items-center gap-2 px-6 py-4 rounded-full font-medium transition-all ${inputText.trim() && !isProcessing ? 'bg-white text-black hover:bg-gray-200 shadow-lg shadow-white/10' : 'bg-gray-800 text-gray-500 cursor-not-allowed'}`}
                                            >
                                                {isProcessing ? (
                                                    <span className="flex items-center gap-2"><Icons.Loader2 className="w-5 h-5 animate-spin" /> Generating...</span>
                                                ) : (
                                                    <span className="flex items-center gap-2"><span>Create Notes & Quiz</span> <Icons.Send className="w-4 h-4" /></span>
                                                )}
                                            </button>
                                        </div>
                                    </div>
                                    {/* --- DARK THEME BOX END --- */}
                                </div>
                            )}

                            {/* RESULTS TAB */}
                            {activeTab === 'results' && (
                                <div className="w-full max-w-5xl h-full flex flex-col gap-6 animate-slide-up">
                                    <div className="flex justify-between items-center bg-white p-2 rounded-lg border border-gray-200 shadow-sm">
                                        <div className="flex items-center gap-2">
                                            {/* FIXED: Added backticks */}
                                            <button onClick={() => setResultTab('notes')} className={`flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium transition-all ${resultTab === 'notes' ? 'bg-slate-100 text-slate-900 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><Icons.FileText className="w-4 h-4" /> Notes</button>
                                            <button onClick={() => setResultTab('quiz')} className={`flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium transition-all ${resultTab === 'quiz' ? 'bg-slate-100 text-slate-900 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><Icons.BookOpen className="w-4 h-4" /> Quiz</button>
                                        </div>
                                        {resultTab === 'notes' && (
                                            <button 
                                                onClick={downloadNotes}
                                                className="flex items-center gap-2 px-4 py-2 bg-slate-800 hover:bg-slate-700 text-white rounded-md text-sm font-medium transition-colors"
                                            >
                                                <Icons.Download className="w-4 h-4" /> Download
                                            </button>
                                        )}
                                    </div>

                                    <div className="flex-1 bg-white rounded-2xl border border-gray-200 shadow-xl shadow-slate-200/50 overflow-hidden p-8 overflow-y-auto custom-scrollbar-light">
                                        {resultTab === 'notes' ? (
                                            <div className="w-full h-full flex justify-center">
                                                <div className="bg-white text-black p-12 max-w-3xl w-full shadow-lg border border-gray-100 rounded-sm min-h-[600px] paper-doc overflow-y-auto custom-scrollbar-light">
                                                    <div className="whitespace-pre-wrap">{generatedNotes}</div>
                                                </div>
                                            </div>
                                        ) : (
                                            <div className="max-w-3xl mx-auto pb-8">
                                                <h2 className="text-2xl font-light text-violet-600 mb-8 text-center">Knowledge Check (10 Questions)</h2>
                                                <div className="flex flex-col gap-8">
                                                    {generatedQuiz.map((q, idx) => (
                                                        <QuizCard key={q.id} question={q} index={idx + 1} />
                                                    ))}
                                                </div>
                                                <div className="mt-12 flex justify-center">
                                                    <button className="px-8 py-3 bg-violet-600 text-white rounded-full font-medium hover:bg-violet-700 transition-colors shadow-lg shadow-violet-200">Submit Quiz</button>
                                                </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* HISTORY TAB */}
                            {activeTab === 'history' && (
                                <div className="w-full max-w-4xl h-full flex flex-col gap-6 animate-slide-up">
                                    <div className="flex justify-end">
                                        <button 
                                            onClick={resetSession}
                                            className="flex items-center gap-2 px-6 py-3 bg-violet-600 hover:bg-violet-700 text-white rounded-full font-medium shadow-lg shadow-violet-200 transition-all"
                                        >
                                            <Icons.Plus className="w-4 h-4" /> New Chat
                                        </button>
                                    </div>
                                    
                                    <div className="grid gap-4 overflow-y-auto custom-scrollbar-light pb-10">
                                        {history.length === 0 ? (
                                            <div className="text-center text-gray-400 mt-20">
                                                <Icons.Clock className="w-12 h-12 mx-auto mb-4 opacity-50" />
                                                <p>No history yet. Start a new session!</p>
                                            </div>
                                        ) : (
                                            history.map((item) => (
                                                <div 
                                                    key={item.id}
                                                    onClick={() => loadHistoryItem(item)}
                                                    className="bg-white p-6 rounded-xl border border-gray-200 hover:border-violet-300 hover:shadow-md cursor-pointer transition-all group"
                                                >
                                                    <div className="flex justify-between items-start mb-2">
                                                        <div className="flex items-center gap-3">
                                                            <div className="w-10 h-10 rounded-full bg-violet-50 flex items-center justify-center text-violet-600 group-hover:bg-violet-600 group-hover:text-white transition-colors">
                                                                <Icons.FileText className="w-5 h-5" />
                                                            </div>
                                                            <div>
                                                                <h3 className="font-medium text-slate-800">Session Review</h3>
                                                                <span className="text-xs text-gray-500">{item.fullDate} • {item.date}</span>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <p className="text-gray-500 text-sm line-clamp-2 pl-[52px]">
                                                        {item.preview}
                                                    </p>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        // FIXED: Added backticks
        const SidebarIcon = ({ icon, active, onClick }) => (
            <button 
                onClick={onClick}
                className={`w-10 h-10 rounded-xl flex items-center justify-center transition-all duration-200 group relative ${active ? 'bg-slate-200 text-violet-600' : 'text-gray-400 hover:text-gray-600 hover:bg-slate-100'}`}
            >
                {React.cloneElement(icon, { size: 20 })}
                {active && <div className="absolute left-0 w-1 h-5 bg-violet-600 rounded-r-full" />}
            </button>
        );

        const QuizCard = ({ question, index }) => {
            const [selected, setSelected] = useState(null);
            
            return (
                <div className="bg-white rounded-xl p-6 border border-gray-200 hover:border-violet-300 transition-colors shadow-sm">
                    <h3 className="text-lg font-medium text-slate-800 mb-4 flex gap-3">
                        <span className="text-violet-600">0{index}.</span>
                        {question.question}
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                        {question.options.map((opt, i) => (
                            <button
                                key={i}
                                onClick={() => setSelected(i)}
                                /* FIXED: Added backticks */
                                className={`p-3 rounded-lg text-left text-sm transition-all border ${
                                    selected === i 
                                        ? 'bg-violet-50 border-violet-500 text-violet-700' 
                                        : 'bg-slate-50 border-gray-200 text-gray-600 hover:bg-slate-100 hover:text-slate-900'
                                }`}
                            >
                                <div className="flex items-center gap-3">
                                    {/* FIXED: Added backticks */ }
                                    <div className={`w-4 h-4 rounded-full border flex items-center justify-center ${selected === i ? 'border-violet-500' : 'border-gray-400'}`}>
                                        {selected === i && <div className="w-2 h-2 bg-violet-500 rounded-full" />}
                                    </div>
                                    {opt}
                                </div>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // Render the App
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
